# An√°lise e Proje√ß√£o de Consumo de Energia com Modelagem de Equa√ß√µes Estruturais (SEM)

## Vis√£o Geral

Este projeto demonstra uma aplica√ß√£o de **Modelos de Equa√ß√µes Estruturais (SEM)** para an√°lise e proje√ß√£o de consumo de energia el√©trica. A abordagem integra vari√°veis econ√¥micas, demogr√°ficas e clim√°ticas em um sistema complexo de equa√ß√µes simult√¢neas, permitindo capturar rela√ß√µes diretas e indiretas entre os fatores que influenciam o consumo energ√©tico.

### Objetivos do Projeto

- **Modelar rela√ß√µes complexas** entre indicadores econ√¥micos e consumo de energia
- **Desenvolver capacidade preditiva** para proje√ß√µes de consumo energ√©tico
- **Incorporar fatores sazonais e clim√°ticos** na modelagem
- **Avaliar performance** atrav√©s de m√©tricas estat√≠sticas robustas

---

## 1. Configura√ß√£o do Ambiente

A primeira etapa garante a disponibilidade de todas as bibliotecas necess√°rias para a an√°lise, utilizando o gerenciador de pacotes `pacman` para automatizar instala√ß√µes e carregamentos.

```{r}
# Instala o pacman se ainda n√£o estiver instalado
if (!require("pacman")) install.packages("pacman")

# Carrega e instala automaticamente os pacotes listados, se necess√°rio
pacman::p_load(DT, lavaan, tidyverse, readxl, plotly, lubridate, tidyr, glmnet, 
               htmltools, gridExtra, htmlwidgets, visNetwork, tibble, funModeling
)
# Salvar em arquivo TXT
#writeLines(capture.output(sessionInfo()), "requirements.txt")

```

**Pacotes-chave utilizados:**
- `lavaan`: Motor principal para Modelagem de Equa√ß√µes Estruturais
- `tidyverse`: Ecosistema para manipula√ß√£o e visualiza√ß√£o de dados
- `lubridate`: Manipula√ß√£o eficiente de vari√°veis temporais
- `readxl`: Interface para arquivos Excel

---

## 2. Carregamento e Inspe√ß√£o dos Dados

```{r}
# Carregar os dados
dados <- read_excel("D:/OneDrive/√Årea de Trabalho/app_SEM/SEM/Dados.xlsx")

# visualizar primeiras linhas
print(head(dados))
```

Esta etapa inicial realiza a importa√ß√£o dos dados e uma verifica√ß√£o preliminar da estrutura, identificando potenciais inconsist√™ncias antes do processamento.

---

## 3. Engenharia de Vari√°veis e Pr√©-processamento

### Transforma√ß√µes Fundamentais

O pr√©-processamento √© crucial para o sucesso do modelo SEM. Aplicamos m√∫ltiplas t√©cnicas de engenharia de vari√°veis para capturar diferentes aspectos dos dados:

```{r}
dados_padronizados <- dados %>%
  mutate(Date = as.Date(data)) %>%
  arrange(Date) %>%
  mutate(
    trend = row_number(),
    trend_scaled = scale(trend)[,1],
    
    # Log-transforma√ß√µes
    log_PIB = log(pib),
    log_MassaRenda = log(massa_renda),
    log_PIM = log(pim),
    log_PMC = log(pmc),
    log_ConsumoEnergia = ifelse(is.na(consumo_energia), NA, log(consumo_energia)),
    log_IPCA = log(indice_precos),
    log_Populacao = log(pop_domicilio),
    log_Temperatura = log(temperatura),
    log_Chuva = log(precipitacao + 1), # evita log(0)
    log_PrecoEnergia = log(tarifa_energia),
    
    # Sazonalidade e intera√ß√µes
    mes = month(data),
    dia = day(data),
    sin1 = sin(2 * pi * mes / 12),
    cos1 = cos(2 * pi * mes / 12),
    sin2 = sin(4 * pi * mes / 12),
    cos2 = cos(4 * pi * mes / 12),
    temp_sin1 = log_Temperatura * sin(2 * pi * mes / 12),
    temp_cos1 = log_Temperatura * cos(2 * pi * mes / 12),
    
    # Dummies sazonais e clim√°ticas
    verao = mes %in% c(12, 1, 2, 3),
    inverno = mes %in% c(6, 7, 8, 9),
    bro_bro = mes %in% c(9, 10, 11, 12),
    d_quente = as.integer(log_Temperatura > mean(log_Temperatura, na.rm = TRUE) + 0.5 * sd(log_Temperatura, na.rm = TRUE)),
    d_frio = as.integer(log_Temperatura < mean(log_Temperatura, na.rm = TRUE) - 0.5 * sd(log_Temperatura, na.rm = TRUE)),

    dummy_pandemia = as.integer(Date >= as.Date("2020-01-01") & Date <= as.Date("2023-01-01")),
    
    # Per√≠odo da crise do impeachment da Dilma (aproximadamente, de Dezembro de 2015 a Agosto de 2016)
    dummy_crises = as.integer(Date >= as.Date("2015-01-01") & Date <= as.Date("2018-01-01"))
  ) 


# Criar vari√°veis dummy para os meses (1 a 12)
for (m in 1:12) {
  coluna_mes <- paste0("mes_", m)
  dados_padronizados[[coluna_mes]] <- as.integer(dados_padronizados$mes == m)
}
```

### Estrat√©gias de Transforma√ß√£o Implementadas

**üìà Transforma√ß√µes Logar√≠tmicas**
- Normaliza√ß√£o de distribui√ß√µes assim√©tricas
- Estabiliza√ß√£o da vari√¢ncia
- Interpreta√ß√£o elasticidade entre vari√°veis

**üîÑ Componentes Sazonais**
- Fun√ß√µes trigonom√©tricas (seno/cosseno) para capturar ciclos anuais
- Vari√°veis dummy mensais para efeitos discretos
- Termos de intera√ß√£o temperatura-sazonalidade

**üå°Ô∏è Vari√°veis Clim√°ticas**
- Classifica√ß√£o de per√≠odos extremos (quente/frio)
- Dummies sazonais (ver√£o, inverno)
- Vari√°veis de precipita√ß√£o tratadas para evitar log(0)

**üìÖ Controles Temporais**
- Tend√™ncia linear e padronizada
- Dummies para eventos estruturais (pandemia, crises pol√≠ticas)

---

## 4. Divis√£o Temporal dos Dados

```{r}
# Data at√© onde os dados s√£o de treino
data_corte <- as.Date("2024-07-01")

# Definir dados de treino
dados_treinamento <- dados_padronizados %>%
  filter(Date <= data_corte, !is.na(log_ConsumoEnergia))

# Definir dados de proje√ß√£o
dados_projecao <- dados_padronizados %>%
  filter(Date > data_corte)
```

A divis√£o temporal simula um cen√°rio realista de previs√£o, onde o modelo √© treinado em dados hist√≥ricos e testado em per√≠odos futuros, garantindo avalia√ß√£o out-of-sample.

---

## 5. Especifica√ß√£o do Modelo SEM

### Arquitetura do Sistema de Equa√ß√µes

O modelo SEM captura a estrutura causal complexa entre as vari√°veis econ√¥micas e o consumo de energia atrav√©s de um sistema hier√°rquico de equa√ß√µes:

```{r}
modelo_sem <- '
  # PIB
  log_PIB ~ log_IPCA + log_Populacao + trend_scaled + sin1 + cos1 + sin2 + cos2 + dummy_pandemia + dummy_crises

  # Massa de Renda
  log_MassaRenda ~ log_Populacao + log_IPCA + log_PIB + trend_scaled + sin1 + cos1 + sin2 + cos2 + dummy_pandemia + dummy_crises

  # PIM
  log_PIM ~ log_PIB  + trend_scaled  + sin1 + cos1 + sin2 + cos2 + dummy_pandemia + dummy_crises

  # PMC
  log_PMC ~ log_PIB + log_MassaRenda + trend_scaled + sin1 + cos1 + sin2 + cos2 + dummy_pandemia + dummy_crises

  # Consumo de Energia
  log_ConsumoEnergia ~ log_PIB + log_PIM + log_PMC + log_MassaRenda +
                        log_Temperatura + log_PrecoEnergia +
                        trend_scaled + sin1 + cos1 + sin2 + cos2 + 
                        d_quente + d_frio + bro_bro + dummy_pandemia + dummy_crises
'

# Estimar o modelo
fit_sem <- sem(modelo_sem, data = dados_treinamento, missing = "fiml")
```

### Estrutura Causal do Modelo

**N√≠vel 1 - Fundamentos Macroecon√¥micos**
- PIB como fun√ß√£o de infla√ß√£o, popula√ß√£o e tend√™ncias

**N√≠vel 2 - Indicadores Intermedi√°rios**  
- Massa de Renda influenciada pelo PIB e vari√°veis macroecon√¥micas
- PIM (Produ√ß√£o Industrial) conectado ao PIB
- PMC (Com√©rcio) dependente de PIB e Massa de Renda

**N√≠vel 3 - Consumo de Energia (Vari√°vel Target)**
- Fun√ß√£o de todos os indicadores econ√¥micos anteriores
- Incorpora√ß√£o de fatores clim√°ticos e pre√ßos de energia
- Controles sazonais e estruturais

**Vantagens da Abordagem SEM:**
- ‚úÖ Captura efeitos diretos e indiretos simultaneamente
- ‚úÖ Trata endogeneidade entre vari√°veis econ√¥micas  
- ‚úÖ Permite decomposi√ß√£o de efeitos causais
- ‚úÖ M√©todo FIML robusto para dados ausentes

## 6. Diagrama do SEM

```{r}
# Definir n√≥s do diagrama
nodes <- data.frame(
  id = c("IPCA", "Populacao", "Temperatura", "Chuva", "PrecoEnergia", "Trend", "Sazonais", "dummies",
         "PIB", "MassaRenda", "PIM", "PMC", "ConsumoEnergia"),
  label = c("IPCA", "Popula√ß√£o", "Temperatura", "Chuva", "Pre√ßo Energia", "Tend√™ncia", "Sazonais", "Dummies",
            "PIB", "Massa Renda", "PIM", "PMC", "Consumo Energia"),
  group = c(rep("Ex√≥genas", 5), rep("Temporais", 2), "Ex√≥genas",  # 'dummies' como ex√≥gena
            rep("End√≥genas", 5)),
  level = c(rep(1, 8), 2, 2, 3, 3, 4),  # 'dummies' no mesmo n√≠vel das ex√≥genas
  color = c(rep("#FF6B6B", 6), "#4ECDC4", "#4ECDC4",  # ex√≥genas e temporais
            rep("#45B7D1", 3), "#96CEB4", "#FFEAA7")  # end√≥genas com cores distintas
)

# Definir arestas (rela√ß√µes causais)
edges <- data.frame(
  from = c("IPCA", "Trend", "Sazonais", "dummies",  # Para PIB
           "Populacao", "IPCA", "PIB", "Trend", "Sazonais", "dummies", # Para MassaRenda
           "PIB", "Trend", "Sazonais", "dummies", # Para PIM
           "PIB", "MassaRenda", "Trend", "Sazonais", "dummies", # Para PMC
           "PIB", "PIM", "PMC", "MassaRenda", "Temperatura", "Chuva", "PrecoEnergia", "Trend", "Sazonais", "dummies"),  # Para ConsumoEnergia
  to = c(rep("PIB", 4),
         rep("MassaRenda", 6),
         rep("PIM", 4),
         rep("PMC", 5),
         rep("ConsumoEnergia", 10)),
  arrows = "to",
  color = "#666666",
  width = 2
)

# Criar diagrama interativo SEM (sem "mola")
diagrama_sem <- visNetwork(nodes, edges, height = "600px", width = "100%") %>%
  visGroups(groupname = "Ex√≥genas", color = "#FF6B6B", shape = "box") %>%
  visGroups(groupname = "Temporais", color = "#4ECDC4", shape = "ellipse") %>%
  visGroups(groupname = "End√≥genas", color = "#45B7D1", shape = "diamond") %>%
  visLegend(width = 0.2, position = "right") %>%
  visLayout(randomSeed = 123, hierarchical = list(enabled = TRUE, direction = "UD", sortMethod = "directed")) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE) %>%
  visInteraction(navigationButtons = TRUE) %>%
  visEdges(arrows = "to", color = list(color = "#666666", highlight = "#FF0000")) %>%
  visPhysics(enabled = FALSE)

# Salvar diagrama como HTML
# saveWidget(diagrama_sem, "diagrama_sem_energia.html", selfcontained = TRUE)
# cat("Diagrama SEM salvo como 'diagrama_sem_energia.html'\n")

# Mostrar diagrama
diagrama_sem


```

---

## 7. Fun√ß√£o de Previs√£o Customizada

### Implementa√ß√£o da Engine de Predi√ß√£o

```{r}
# Obter os coeficientes padronizados ou n√£o
coeficientes <- parameterEstimates(fit_sem)

prever_variavel_sem <- function(modelo_sem, dados_novos, variavel_destino) {
  # Extrair coeficientes das vari√°veis explicativas
  coefs <- parameterEstimates(modelo_sem) %>%
    filter(lhs == variavel_destino & op == "~") %>%
    select(rhs, est)
  
  # Extrair intercepto (se existir)
  intercepto <- parameterEstimates(modelo_sem) %>%
    filter(lhs == variavel_destino & op == "~1") %>%
    pull(est)
  
  if (length(intercepto) == 0) intercepto <- 0  # caso n√£o tenha intercepto
  
  # Verificar se todas as vari√°veis est√£o nos dados
  faltantes <- setdiff(coefs$rhs, names(dados_novos))
  if (length(faltantes) > 0) {
    stop(paste("Vari√°veis ausentes nos dados:", paste(faltantes, collapse = ", ")))
  }
  
  # Calcular a predi√ß√£o como soma ponderada + intercepto
  previsao <- rowSums(
    sapply(coefs$rhs, function(var) {
      dados_novos[[var]] * coefs$est[coefs$rhs == var]
    }), na.rm = TRUE
  ) + intercepto
  
  return(previsao)
}
```

Esta fun√ß√£o personalizada extrai automaticamente os coeficientes estimados do modelo SEM e aplica a combina√ß√£o linear para gerar previs√µes, oferecendo flexibilidade para prever qualquer vari√°vel end√≥gena do sistema.

---

## 8. Gera√ß√£o de Proje√ß√µes

```{r}
dados_projecao$log_ConsumoEnergia_prevista <- prever_variavel_sem(
  modelo_sem = fit_sem,
  dados_novos = dados_projecao,
  variavel_destino = "log_ConsumoEnergia"
)

# Juntar os dados de treino e proje√ß√£o com a vari√°vel observada e a prevista
resultados <- dados_padronizados %>%
  select(Date, log_ConsumoEnergia) %>%
  left_join(
    dados_projecao %>%
      select(Date, log_ConsumoEnergia_prevista),
    by = "Date"
  ) %>%
  mutate(
    ConsumoEnergia_real = exp(log_ConsumoEnergia),
    ConsumoEnergia_prevista = exp(log_ConsumoEnergia_prevista)
  )
```

As proje√ß√µes s√£o geradas aplicando os coeficientes estimados aos dados futuros, com transforma√ß√£o inversa (exponencial) para retornar √† escala original dos dados.

---

## 9. Avalia√ß√£o de Performance

### M√©trica MAPE (Mean Absolute Percentage Error)

```{r}
# Prever log_ConsumoEnergia nos dados de treino
dados_treinamento$log_ConsumoEnergia_prevista <- prever_variavel_sem(
  modelo_sem = fit_sem,
  dados_novos = dados_treinamento,
  variavel_destino = "log_ConsumoEnergia"
)

# Calcular valores reais e previstos na escala original
dados_treinamento <- dados_treinamento %>%
  mutate(
    ConsumoEnergia_real = exp(log_ConsumoEnergia),
    ConsumoEnergia_prevista = exp(log_ConsumoEnergia_prevista)
  )

# √öltimos 12 meses antes da data de corte
dados_mape <- dados_treinamento %>%
  filter(Date > (data_corte %m-% months(6)), Date <= data_corte)

# Calcular MAPE
mape <- mean(abs((dados_mape$ConsumoEnergia_real - dados_mape$ConsumoEnergia_prevista) / dados_mape$ConsumoEnergia_real), na.rm = TRUE) * 100

# Exibir
cat("MAPE dos √∫ltimos 12 meses antes da previs√£o:", round(mape, 2), "%\n")
```

O MAPE √© calculado nos √∫ltimos 6 meses do per√≠odo de treinamento, fornecendo uma m√©trica interpret√°vel (em percentual) da acur√°cia preditiva do modelo em dados quasi-out-of-sample.

---

## 10. Visualiza√ß√£o dos Resultados

```{r}
# Unir os conjuntos (mant√©m a mesma l√≥gica de antes)
resultados_completos <- bind_rows(
  dados_treinamento %>% select(Date, ConsumoEnergia_real, ConsumoEnergia_prevista),
  dados_projecao %>%
    mutate(
      ConsumoEnergia_real = NA, # Valores reais s√£o NA para o per√≠odo de proje√ß√£o
      ConsumoEnergia_prevista = exp(log_ConsumoEnergia_prevista) # Transforma para a escala original
    ) %>%
    select(Date, ConsumoEnergia_real, ConsumoEnergia_prevista)
)


library(ggplot2)

ggplot(resultados_completos, aes(x = Date)) +
  # Linhas de s√©rie real e prevista
  geom_line(aes(y = ConsumoEnergia_real, color = "Realizado"), size = 1.2, na.rm = TRUE) +
  geom_line(aes(y = ConsumoEnergia_prevista, color = "Previsto"), size = 1.2, na.rm = TRUE) +
  
  # Linha vertical indicando in√≠cio da proje√ß√£o
  geom_vline(xintercept = as.numeric(data_corte), linetype = "dotted", color = "black") +
  
  # Anota√ß√£o da linha de corte
  annotate("text",
           x = data_corte,
           y = Inf,
           label = "In√≠cio da Proje√ß√£o",
           vjust = -0.5,
           hjust = -0.1,
           size = 4.5,
           fontface = "italic") +
  
  # Anota√ß√£o do MAPE
  annotate("text",
           x = min(resultados_completos$Date, na.rm = TRUE),
           y = max(resultados_completos$ConsumoEnergia_real, na.rm = TRUE),
           label = paste0("MAPE √∫ltimos 12 meses: ", round(mape, 2), "%"),
           hjust = 0,
           vjust = 1.5,
           size = 5,
           color = "black",
           fontface = "bold") +

  # T√≠tulos e eixos
  labs(
    title = "Consumo de Energia: Realizado vs. Previsto",
    y = "Consumo de Energia (kWh, escala original)",
    x = "Data",
    color = NULL  # Remove o t√≠tulo da legenda ("color")
  ) +

  # Cores definidas manualmente
  scale_color_manual(values = c("Realizado" = "steelblue", "Previsto" = "firebrick")) +

  # Tema minimalista com ajustes
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",       # Legenda abaixo do gr√°fico
    legend.title = element_blank(),   # Remove o t√≠tulo da legenda
    plot.title = element_text(face = "bold", hjust = 0.5),  # Centraliza o t√≠tulo
    legend.text = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13)
  )
```

```{r}

```

---

## Limita√ß√µes e Considera√ß√µes Metodol√≥gicas

### Limita√ß√µes da Modelagem SEM para Proje√ß√µes

Embora os Modelos de Equa√ß√µes Estruturais ofere√ßam vantagens significativas para capturar rela√ß√µes complexas, √© importante reconhecer suas limita√ß√µes espec√≠ficas no contexto de proje√ß√µes de s√©ries temporais:

#### üî¥ **Limita√ß√µes Estruturais**

**1. Suposi√ß√µes de Linearidade**
- SEM assume rela√ß√µes lineares entre vari√°veis, o que pode n√£o capturar adequadamente din√¢micas n√£o-lineares complexas do consumo de energia
- Mudan√ßas estruturais abruptas no sistema energ√©tico podem n√£o ser bem modeladas

**2. Estabilidade Temporal dos Par√¢metros**
- O modelo assume que as rela√ß√µes entre vari√°veis permanecem constantes ao longo do tempo
- Mudan√ßas regulat√≥rias, tecnol√≥gicas ou comportamentais podem alterar fundamentalmente essas rela√ß√µes

**3. Propaga√ß√£o de Erros**
- Em sistemas de equa√ß√µes simult√¢neas, erros de estima√ß√£o se propagam atrav√©s da cadeia causal
- Pequenos erros em vari√°veis econ√¥micas fundamentais podem resultar em grandes desvios nas proje√ß√µes finais

#### üî¥ **Limita√ß√µes Espec√≠ficas para Proje√ß√µes**

**4. Depend√™ncia de Vari√°veis Ex√≥genas**
- A qualidade das proje√ß√µes depende criticamente da disponibilidade e acur√°cia das vari√°veis explicativas futuras
- PIB, popula√ß√£o, pre√ßos - todas requerem suas pr√≥prias proje√ß√µes, adicionando incerteza cumulativa

**5. Aus√™ncia de Mecanismos de Corre√ß√£o**
- Diferentemente de modelos de s√©ries temporais puros (ARIMA, VAR), SEM n√£o incorpora mecanismos de corre√ß√£o de erro autom√°ticos
- N√£o h√° ajuste din√¢mico baseado em desvios observados

**6. Sensibilidade a Quebras Estruturais**
- Eventos como crises energ√©ticas, mudan√ßas de matriz energ√©tica ou pol√≠ticas clim√°ticas podem invalidar completamente as rela√ß√µes modeladas
- O modelo pode falhar em per√≠odos de transforma√ß√£o estrutural

#### üî¥ **Limita√ß√µes T√©cnicas**

**7. Identifica√ß√£o e Causalidade**
- Embora SEM permita testar hip√≥teses causais, a identifica√ß√£o de rela√ß√µes verdadeiramente causais depende de suposi√ß√µes te√≥ricas que podem ser violadas
- Vari√°veis omitidas podem confundir as rela√ß√µes estimadas

**8. Multicolinearidade em Sistemas Complexos**
- Vari√°veis econ√¥micas frequentemente exibem alta correla√ß√£o, complicando a identifica√ß√£o de efeitos individuais
- Pode levar a instabilidade nos coeficientes estimados

#### ‚ö° **Alternativas Complementares**

Para mitigar essas limita√ß√µes, seria recomend√°vel considerar:

- **Modelos h√≠bridos** combinando SEM com m√©todos de s√©ries temporais
- **Abordagens de machine learning** para capturar n√£o-linearidades
- **Modelos de mudan√ßa de regime** para lidar com quebras estruturais
- **M√©todos ensemble** combinando m√∫ltiplas abordagens de modelagem
- **Intervalos de confian√ßa robustos** atrav√©s de bootstrap ou simula√ß√£o

#### üìä **Contexto de Aplica√ß√£o**

O SEM √© mais apropriado para:
- ‚úÖ An√°lise de rela√ß√µes estruturais entre vari√°veis
- ‚úÖ Proje√ß√µes de m√©dio prazo em ambientes est√°veis
- ‚úÖ Decomposi√ß√£o de efeitos causais
- ‚úÖ Cen√°rios com boa disponibilidade de vari√°veis explicativas

E menos adequado para:
- ‚ùå Proje√ß√µes de muito longo prazo
- ‚ùå Per√≠odos de alta volatilidade ou mudan√ßa estrutural
- ‚ùå Situa√ß√µes com dados limitados de vari√°veis explicativas
- ‚ùå Quando a precis√£o pontual √© cr√≠tica

---

## Conclus√£o

Este projeto demonstra uma aplica√ß√£o sofisticada de Modelagem de Equa√ß√µes Estruturais para an√°lise de consumo energ√©tico, integrando m√∫ltiplas dimens√µes (econ√¥mica, clim√°tica, temporal) em um framework estat√≠stico robusto. A abordagem oferece insights valiosos sobre as rela√ß√µes estruturais subjacentes, embora deva ser utilizada com consci√™ncia de suas limita√ß√µes metodol√≥gicas para aplica√ß√µes de proje√ß√£o.

**Principais Contribui√ß√µes:**
- Framework integrado para modelagem multi-dimensional de consumo energ√©tico
- Implementa√ß√£o robusta de SEM com tratamento de dados ausentes
- Sistema de avalia√ß√£o quantitativa de performance preditiva
- C√≥digo modular e reutiliz√°vel para an√°lises similares

Este trabalho representa uma s√≠ntese entre rigor metodol√≥gico e aplicabilidade pr√°tica, adequado para contextos de planejamento energ√©tico onde a compreens√£o das rela√ß√µes estruturais √© t√£o importante quanto a capacidade preditiva.